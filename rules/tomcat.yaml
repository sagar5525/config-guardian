# rules/tomcat.yaml
rules:
  - id: "TOMCAT-001"
    name: "Debug Mode Enabled"
    description: "Context has debug attribute set, which may expose internal details."
    file_type: "server.xml"
    xpath: "//Context/@debug[. != '0']"
    condition: "exists"
    severity: "Medium"
    remediation: "Remove the 'debug' attribute or set it to '0'."
    reference: "https://tomcat.apache.org/security.html"

  - id: "TOMCAT-002"
    name: "Manager App Not Removed"
    description: "Tomcat Manager or Host Manager webapp is deployed but not secured."
    file_type: "server.xml"
    xpath: "//Context[@docBase='manager' or @docBase='host-manager']"
    condition: "exists"
    severity: "High"
    remediation: "Remove the webapp directory or restrict access via IP firewall or <Valve>."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/manager-howto.html"

  - id: "TOMCAT-003"
    name: "Insecure HTTP Connector on Default Port"
    description: "HTTP connector listening on default port 8080 without HTTPS redirection."
    file_type: "server.xml"
    xpath: "//Connector[@protocol='HTTP/1.1' and @port='8080' and not(@redirectPort)]"
    condition: "exists"
    severity: "Low"
    remediation: "Disable in production or redirect to HTTPS using redirectPort='8443'."
    reference: "https://httpd.apache.org/docs/2.4/ssl/ssl_howto.html"

  - id: "TOMCAT-004"
    name: "SSL/TLS Not Configured"
    description: "No HTTPS (SSL/TLS) connector defined."
    file_type: "server.xml"
    xpath: "//Connector[@scheme='https' or @sslenabled='true']"
    condition: "not(exists)"
    severity: "High"
    remediation: "Add a secure HTTPS connector with strong ciphers and valid certificate."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/ssl-howto.html"

  - id: "TOMCAT-005"
    name: "Weak SSL/TLS Protocols Enabled"
    description: "SSL/TLS connector allows outdated protocols like SSLv3, TLSv1, or TLSv1.1."
    file_type: "server.xml"
    xpath: "//Connector[@sslenabled='true' and (contains(translate(@sslProtocols, ' ', ''), 'SSL') or contains(translate(@sslProtocols, ' ', ''), 'TLSv1') or contains(translate(@sslProtocol, ' ', ''), 'SSL') or contains(translate(@sslProtocol, ' ', ''), 'TLSv1'))]"
    condition: "exists"
    severity: "High"
    remediation: "Set sslProtocols='TLSv1.2,TLSv1.3' and disable older versions."
    reference: "https://cheatsheetseries.owasp.org/cheatsheets/Transport_Layer_Protection_Cheat_Sheet.html"

  - id: "TOMCAT-006"
    name: "Session Timeout Not Set"
    description: "Session timeout is not configured, leading to prolonged session exposure."
    file_type: "server.xml"
    xpath: "//Context[not(@sessionTimeout)] | //session-config[not(session-timeout)]"
    condition: "exists"
    severity: "Medium"
    remediation: "Set session timeout to 15-30 minutes using <session-timeout> in web.xml or @sessionTimeout in Context."
    reference: "https://cheatsheetseries.owasp.org/cheatsheets/Session_Management_Cheat_Sheet.html"

  - id: "TOMCAT-007"
    name: "AJP Connector Exposed"
    description: "AJP connector is enabled and may be exposed to attackers (e.g., CVE-2020-1938)."
    file_type: "server.xml"
    xpath: "//Connector[@protocol='AJP/1.3' and not(@address)]"
    condition: "exists"
    severity: "High"
    remediation: "Disable AJP if not needed, or bind to localhost using address='127.0.0.1'."
    reference: "https://nvd.nist.gov/vuln/detail/CVE-2020-1938"

  - id: "TOMCAT-008"
    name: "CORS Enabled for All Origins"
    description: "CORS filter allows all domains (access-control-allow-origin: *)."
    file_type: "server.xml"
    xpath: "//Filter/FilterName[text()='CORS']/following::InitParam[ParamName='cors.allowOrigin']/ParamValue[text()='*']"
    condition: "exists"
    severity: "Medium"
    remediation: "Whitelist only trusted domains in CORS configuration."
    reference: "https://owasp.org/www-project-secure-headers/#cors"

  - id: "TOMCAT-009"
    name: "Server Version Disclosure"
    description: "Server header exposes Tomcat version in responses."
    file_type: "server.xml"
    xpath: "//Connector[@server and string-length(@server) > 0]"
    condition: "exists"
    severity: "Low"
    remediation: "Set server='Apache' or remove the attribute to hide version."
    reference: "https://owasp.org/www-project-secure-headers/#server"

  - id: "TOMCAT-010"
    name: "Default Host Not Set"
    description: "No defaultHost defined in Engine, which may lead to routing issues."
    file_type: "server.xml"
    xpath: "//Engine[not(@defaultHost)]"
    condition: "exists"
    severity: "Medium"
    remediation: "Define a defaultHost to prevent unexpected host routing."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/config/engine.html"

  - id: "TOMCAT-011"
    name: "Remote IP Valve Not Configured"
    description: "X-Forwarded-* headers not validated; risk of IP spoofing behind reverse proxy."
    file_type: "server.xml"
    xpath: "//Valve[@className='org.apache.catalina.valves.RemoteIpValve'][not(@internalProxies) or not(@trustedProxies)]"
    condition: "exists"
    severity: "Medium"
    remediation: "Configure internalProxies and trustedProxies in RemoteIpValve."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/api/org/apache/catalina/valves/RemoteIpValve.html"

  - id: "TOMCAT-012"
    name: "Access Log Not Configured"
    description: "No access log defined; missing audit trail for traffic."
    file_type: "server.xml"
    xpath: "//Valve[@className='org.apache.catalina.valves.AccessLogValve']"
    condition: "not(exists)"
    severity: "Medium"
    remediation: "Enable access logging with proper format (e.g., combined) and rotation."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/config/valve.html#Access_Log_Valve"

  - id: "TOMCAT-013"
    name: "Session Persistence Enabled"
    description: "Sessions are being persisted across restarts, risking data leakage."
    file_type: "server.xml"
    xpath: "//Manager[@className='org.apache.catalina.session.PersistentManager']"
    condition: "exists"
    severity: "Medium"
    remediation: "Disable session persistence in production unless required for HA with secure storage."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/config/manager.html"

  - id: "TOMCAT-014"
    name: "Unrestricted Upload Directory"
    description: "No restriction on upload directory; potential for malicious file execution."
    file_type: "server.xml"
    xpath: "//Context[@allowLinking='true' or @crossContext='true']"
    condition: "exists"
    severity: "Medium"
    remediation: "Set allowLinking='false', crossContext='false' unless explicitly needed."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html"

  - id: "TOMCAT-015"
    name: "JMX Remote Access Enabled"
    description: "JMX remote management is enabled without authentication."
    file_type: "server.xml"
    xpath: "//Listener[@className='org.apache.catalina.mbeans.JmxRemoteLifecycleListener']"
    condition: "exists"
    severity: "High"
    remediation: "Disable JMX remote or enforce strong authentication and encryption."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/jmx.html"

  # --- New Rules Based on Tomcat Security How-To ---

  - id: "TOMCAT-SEC-001"
    name: "Shutdown Port Not Disabled"
    description: "The shutdown port is enabled and may be vulnerable to unauthorized shutdown commands if a weak password is used."
    file_type: "server.xml"
    xpath: "//Server[@port and @port != '-1']"
    condition: "exists"
    severity: "Medium"
    remediation: "Set the 'port' attribute of the <Server> element to '-1' to disable the shutdown port, or use a strong, complex password for the 'shutdown' command."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Server"

  - id: "TOMCAT-SEC-002"
    name: "Security Lifecycle Listener Not Enabled"
    description: "The Security Lifecycle Listener can perform additional security checks at startup."
    file_type: "server.xml"
    xpath: "//Listener[@className='org.apache.catalina.security.SecurityListener']"
    condition: "not(exists)"
    severity: "Low"
    remediation: "Consider enabling the Security Lifecycle Listener by adding <Listener className='org.apache.catalina.security.SecurityListener' /> to server.xml."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Listeners"

  - id: "TOMCAT-SEC-003"
    name: "TRACE Method Enabled"
    description: "The TRACE method is enabled, which can potentially be used for Cross-Site Scripting (XSS) attacks in some browsers."
    file_type: "server.xml"
    xpath: "//Connector[@allowTrace='true']"
    condition: "exists"
    severity: "Medium"
    remediation: "Ensure the 'allowTrace' attribute on Connectors is not set to 'true'. It is 'false' by default."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Connectors"

  - id: "TOMCAT-SEC-004"
    name: "X-Powered-By Header Enabled"
    description: "The X-Powered-By header reveals technology details (Servlet/JSP versions, Tomcat version, JVM info) that could be useful to attackers."
    file_type: "server.xml"
    xpath: "//Connector[@xpoweredBy='true']"
    condition: "exists"
    severity: "Low"
    remediation: "Ensure the 'xpoweredBy' attribute on Connectors is not set to 'true'. It is 'false' by default."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Connectors"

  - id: "TOMCAT-SEC-005"
    name: "Automatic Deployment Enabled"
    description: "Automatic deployment (autoDeploy or deployOnStartup) can make it easier for an attacker to deploy a malicious application if they gain access."
    file_type: "server.xml"
    xpath: "//Host[@autoDeploy='true' or @deployOnStartup='true']"
    condition: "exists"
    severity: "Medium"
    remediation: "For production, set both 'autoDeploy' and 'deployOnStartup' attributes on the <Host> element to 'false'."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Host"

  - id: "TOMCAT-SEC-006"
    name: "Privileged Context Found"
    description: "A Context is marked as 'privileged', allowing it to use container-provided servlets like the Manager servlet. This should be limited to trusted applications."
    file_type: "server.xml"
    xpath: "//Context[@privileged='true']"
    condition: "exists"
    severity: "High"
    remediation: "Ensure the 'privileged' attribute on <Context> elements is not set to 'true' unless absolutely necessary for a trusted application. It is 'false' by default."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Context"

  - id: "TOMCAT-SEC-007"
    name: "Cross Context Access Enabled"
    description: "A Context allows cross-context access, enabling it to access resources from other contexts. This should be limited to trusted applications."
    file_type: "server.xml"
    xpath: "//Context[@crossContext='true']"
    condition: "exists"
    severity: "Medium"
    remediation: "Ensure the 'crossContext' attribute on <Context> elements is not set to 'true' unless absolutely necessary for a trusted application. It is 'false' by default."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Context"

  - id: "TOMCAT-SEC-008"
    name: "Allow Linking Enabled"
    description: "The 'allowLinking' attribute on a Context's Resources is enabled, which can disable security measures and allow direct access to WEB-INF on case-insensitive systems."
    file_type: "server.xml"
    xpath: "//Context/Resources[@allowLinking='true']"
    condition: "exists"
    severity: "High"
    remediation: "Ensure the 'allowLinking' attribute on <Resources> within <Context> elements is not set to 'true'. It is 'false' by default."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Context"

  - id: "TOMCAT-SEC-009"
    name: "Error Report Valve Shows Server Info"
    description: "The default ErrorReportValve includes the Tomcat version number in error responses, revealing server information."
    file_type: "server.xml"
    xpath: "//Valve[@className='org.apache.catalina.valves.ErrorReportValve' and not(@showServerInfo='false')]"
    condition: "exists"
    severity: "Low"
    remediation: "Explicitly configure an ErrorReportValve with 'showServerInfo' set to 'false', or implement custom error pages in your applications."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Valves"

  - id: "TOMCAT-SEC-010"
    name: "Error Report Valve Shows Detailed Reports"
    description: "The default ErrorReportValve can display stack traces and/or JSP source code to clients, potentially leaking sensitive information."
    file_type: "server.xml"
    xpath: "//Valve[@className='org.apache.catalina.valves.ErrorReportValve' and not(@showReport='false')]"
    condition: "exists"
    severity: "Medium"
    remediation: "Explicitly configure an ErrorReportValve with 'showReport' set to 'false', or implement custom error pages in your applications."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Valves"

  - id: "TOMCAT-SEC-011"
    name: "Remote Address Valve Missing for Admin App"
    description: "Administrative applications (like Manager/Host Manager) should be protected by a RemoteAddrValve to limit access to trusted hosts."
    file_type: "server.xml"
    xpath: "//Context[@docBase='manager' or @docBase='host-manager']/Valve[@className='org.apache.catalina.valves.RemoteAddrValve']"
    condition: "not(exists)"
    severity: "High"
    remediation: "Protect administrative applications by configuring a RemoteAddrValve (e.g., in their context.xml) to allow access only from specific, trusted IP addresses."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Securing_Management_Applications"

  - id: "TOMCAT-SEC-012"
    name: "Cluster Used on Insecure Network"
    description: "Tomcat clustering is designed for secure, trusted networks. Running it on an insecure network exposes it to various attacks."
    file_type: "server.xml"
    xpath: "//Cluster"
    condition: "exists"
    severity: "High"
    remediation: "Ensure Tomcat clusters operate only on secure, trusted networks. Consider using the EncryptInterceptor for confidentiality/integrity if necessary, though it doesn't protect against all risks like DoS."
    reference: "https://tomcat.apache.org/tomcat-9.0-doc/security-howto.html#Cluster"
