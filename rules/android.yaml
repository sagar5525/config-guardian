rules:

  - id: "ANDROID-001"
    name: "App is Debuggable"
    description: "android:debuggable='true' allows code inspection and runtime manipulation."
    file_type: "AndroidManifest.xml"
    xpath: "/manifest/application/@android:debuggable[. = 'true']"
    condition: "exists"
    severity: "High"
    remediation: "Set android:debuggable='false' or remove (defaults to false)."
    reference: "https://developer.android.com/tools/debugging"
    masvs: "V7.4"

  - id: "ANDROID-002"
    name: "Backup Enabled"
    description: "android:allowBackup='true' may lead to data leakage via adb backup."
    file_type: "AndroidManifest.xml"
    xpath: "/manifest/application/@android:allowBackup[. = 'true']"
    condition: "exists"
    severity: "Medium"
    remediation: "Set android:allowBackup='false' to prevent unintended data backup."
    reference: "https://developer.android.com/guide/topics/data/autobackup"
    masvs: "V1.4"

  - id: "ANDROID-003"
    name: "Exported Activity Without Permission"
    description: "Activity is exported and accessible by other apps without permission."
    file_type: "AndroidManifest.xml"
    xpath: "//activity[@android:exported='true' and not(@android:permission)]"
    condition: "exists"
    severity: "High"
    remediation: "Set android:exported='false' unless intentional exposure. Use custom permission if needed."
    reference: "https://developer.android.com/guide/topics/manifest/activity-element#exported"
    masvs: "V6.4"

  - id: "ANDROID-004"
    name: "Exported Service Without Permission"
    description: "Service is exported and can be invoked by other apps."
    file_type: "AndroidManifest.xml"
    xpath: "//service[@android:exported='true' and not(@android:permission)]"
    condition: "exists"
    severity: "High"
    remediation: "Set android:exported='false' or enforce access with android:permission."
    reference: "https://developer.android.com/guide/components/services"
    masvs: "V6.4"

  - id: "ANDROID-005"
    name: "Content Provider Exported"
    description: "Content provider is exported and accessible to third-party apps."
    file_type: "AndroidManifest.xml"
    xpath: "//provider[@android:exported='true']"
    condition: "exists"
    severity: "High"
    remediation: "Set android:exported='false' unless sharing data. Use android:permission to restrict access."
    reference: "https://developer.android.com/guide/topics/providers/content-providers"
    masvs: "V6.4"

  - id: "ANDROID-006"
    name: "Broadcast Receiver Exported"
    description: "Broadcast receiver is exported and listens to global broadcasts."
    file_type: "AndroidManifest.xml"
    xpath: "//receiver[@android:exported='true']"
    condition: "exists"
    severity: "Medium"
    remediation: "Set android:exported='false' for internal receivers. Use local broadcasts."
    reference: "https://developer.android.com/guide/components/broadcasts"
    masvs: "V6.4"

  - id: "ANDROID-007"
    name: "Insecure WebView Settings"
    description: "WebView has JavaScript enabled and file access allowed, increasing attack surface."
    file_type: "AndroidManifest.xml"
    xpath: "//activity[contains(@android:name, 'Web') or contains(@android:label, 'Web')]//meta-data[@android:name='allowJs' and @android:value='true']"
    condition: "exists"
    severity: "High"
    remediation: "Disable JavaScript unless required. Avoid loading untrusted content. Use setAllowFileAccess(false)."
    reference: "https://developer.android.com/reference/android/webkit/WebSettings"
    masvs: ""

  - id: "ANDROID-008"
    name: "Cleartext Traffic Allowed"
    description: "android:usesCleartextTraffic='true' allows HTTP traffic (unencrypted)."
    file_type: "AndroidManifest.xml"
    xpath: "/manifest/application/@android:usesCleartextTraffic[. = 'true']"
    condition: "exists"
    severity: "High"
    remediation: "Set android:usesCleartextTraffic='false' and use HTTPS only."
    reference: "https://developer.android.com/guide/topics/manifest/application-element#usesCleartextTraffic"
    masvs: "V5.1"

  - id: "ANDROID-009"
    name: "Over-Privileged App"
    description: "App requests excessive permissions (e.g., SEND_SMS, READ_CONTACTS)."
    file_type: "AndroidManifest.xml"
    xpath: "//uses-permission[@android:name='android.permission.SEND_SMS' or @android:name='android.permission.CALL_PHONE' or @android:name='android.permission.READ_SMS' or @android:name='android.permission.READ_CONTACTS' or @android:name='android.permission.RECORD_AUDIO']"
    condition: "exists"
    severity: "Medium"
    remediation: "Request only permissions essential to app functionality. Use runtime permissions."
    reference: "https://developer.android.com/guide/topics/security/permissions"
    masvs: "V6.1"

  - id: "ANDROID-010"
    name: "Task Affinity Misconfigured"
    description: "android:taskAffinity allows app to be grouped with other tasks, risking phishing."
    file_type: "AndroidManifest.xml"
    xpath: "//activity[@android:taskAffinity and @android:taskAffinity != '']"
    condition: "exists"
    severity: "Medium"
    remediation: "Avoid setting taskAffinity unless required. Prevent task hijacking."
    reference: "https://developer.android.com/guide/topics/manifest/activity-element#aff"
    masvs: "V1.9"

  - id: "ANDROID-011"
    name: "Exported Receiver with Implicit Intent"
    description: "Receiver listens on implicit intent without permission, risking data leak."
    file_type: "AndroidManifest.xml"
    xpath: "//receiver[@android:exported='true']//intent-filter[not(@android:priority='1000')]"
    condition: "exists"
    severity: "High"
    remediation: "Use explicit intents or enforce permissions on receivers."
    reference: "https://developer.android.com/guide/components/broadcasts#security"
    masvs: "V6.4"

  - id: "ANDROID-012"
    name: "Backup to Cloud Enabled"
    description: "Auto backup to Google Drive is enabled, risking data exposure."
    file_type: "AndroidManifest.xml"
    xpath: "/manifest/application/@android:allowBackup[. = 'true']"
    condition: "exists"
    severity: "Medium"
    remediation: "Disable backup or use android:fullBackupContent to restrict sensitive data."
    reference: "https://developer.android.com/guide/topics/data/autobackup"
    masvs: "V1.4"

  - id: "ANDROID-013"
    name: "Intent Scheme URL Support"
    description: "App supports intent:// URLs which are prone to confusion and phishing."
    file_type: "AndroidManifest.xml"
    xpath: "//intent-filter//data[@android:scheme='intent']"
    condition: "exists"
    severity: "Medium"
    remediation: "Avoid intent schemes. Use deep links with app links (digital asset links)."
    reference: "https://developer.android.com/training/app-links"
    masvs: "V6.5"

  - id: "ANDROID-014"
    name: "Custom Scheme Without Validation"
    description: "Custom URL scheme (e.g., myapp://) without proper validation."
    file_type: "AndroidManifest.xml"
    xpath: "//intent-filter//data[starts-with(@android:scheme, 'myapp') or starts-with(@android:scheme, 'app')]"
    condition: "exists"
    severity: "Medium"
    remediation: "Validate incoming URLs and use Android App Links with Digital Asset Links for security."
    reference: "https://developer.android.com/training/app-links/verify-site-associations"
    masvs: "V6.5"

  - id: "ANDROID-015"
    name: "Protected Broadcast Receiver"
    description: "Receiver listens on protected broadcast (e.g., BOOT_COMPLETED) without permission."
    file_type: "AndroidManifest.xml"
    xpath: "//receiver//intent-filter//action[@android:name='android.intent.action.BOOT_COMPLETED']"
    condition: "exists"
    severity: "Low"
    remediation: "Ensure sensitive receivers are not over-exported. Use <permission> if needed."
    reference: "https://developer.android.com/guide/components/broadcasts#security"
    masvs: "V6.4"


  # === üõ°Ô∏è OWASP MASVS COMPLIANCE RULES ===

  - id: "MASVS-V4-01"
    name: "Biometric Authentication Enforced"
    description: "App should use biometric authentication for sensitive operations."
    file_type: "AndroidManifest.xml"
    xpath: "//uses-permission[@android:name='android.permission.USE_BIOMETRIC']"
    condition: "not(exists)"
    severity: "Info"
    remediation: "Consider adding android.permission.USE_BIOMETRIC and using BiometricPrompt for secure auth."
    reference: "https://developer.android.com/reference/androidx/biometric/BiometricPrompt"
    masvs: "V4.2"

  - id: "MASVS-V4-02"
    name: "Keyguard Integration"
    description: "App should integrate with device lock screen (e.g., KeyguardManager)."
    file_type: "AndroidManifest.xml"
    xpath: "//uses-permission[@android:name='android.permission.DISABLE_KEYGUARD']"
    condition: "exists"
    severity: "Medium"
    remediation: "Avoid disabling keyguard. Use KeyguardManager.isKeyguardLocked() instead."
    reference: "https://developer.android.com/reference/android/app/KeyguardManager"
    masvs: "V4.3"

  - id: "MASVS-V5-02"
    name: "Network Security Config Defined"
    description: "App should define network_security_config for TLS and domain pinning."
    file_type: "AndroidManifest.xml"
    xpath: "/manifest/application/@android:networkSecurityConfig"
    condition: "not(exists)"
    severity: "Medium"
    remediation: "Add android:networkSecurityConfig='@xml/network_security_config' with custom rules and pinning."
    reference: "https://developer.android.com/training/articles/security-config"
    masvs: "V5.4"

  - id: "MASVS-V7-01"
    name: "Obfuscation Enabled"
    description: "ProGuard or R8 should be enabled to deter reverse engineering."
    file_type: "AndroidManifest.xml"
    xpath: "//meta-data[@android:name='com.example.obfuscation.disabled']"
    condition: "exists"
    severity: "Info"
    remediation: "Enable minifyEnabled in build.gradle and configure proguard-rules.pro."
    reference: "https://developer.android.com/studio/build/shrink-code"
    masvs: "V7.1"

  - id: "MASVS-V7-02"
    name: "Exported Instrumentation"
    description: "Instrumentation components should not be exported."
    file_type: "AndroidManifest.xml"
    xpath: "//instrumentation[@android:exported='true']"
    condition: "exists"
    severity: "High"
    remediation: "Set android:exported='false' for instrumentation components."
    reference: "https://developer.android.com/guide/topics/manifest/instrumentation-element"
    masvs: "V7.4"

  - id: "MASVS-V3-01"
    name: "Secure Random Usage"
    description: "App should not use insecure RNG (e.g., Math.random)."
    file_type: "AndroidManifest.xml"
    xpath: "//uses-library[@android:name='org.apache.http.legacy'][@android:required='true']"
    condition: "exists"
    severity: "Info"
    remediation: "Not detectable in manifest. Recommend using SecureRandom in code."
    reference: "https://developer.android.com/reference/java/security/SecureRandom"
    masvs: "V3.5"
